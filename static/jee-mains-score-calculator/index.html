<!doctype html>
<html lang="en">
<head>
    <title>Score Calculator</title>
    <meta http-equiv="Expires" content="-1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WHXSWGK');</script>
    <!-- End Google Tag Manager -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
            crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WHXSWGK"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <span style="margin-left:2%"><a class="navbar-brand" href="#">JEE Main Score Calculator</a></span>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
            </li>
        </ul>
    </div>
</nav>
<div class="row flex-xl-nowrap">
    <div class="col-12 col-md-1 col-xl-1"></div>
    <main class="col-12 col-md-10 col-xl-10 py-md-3">
        <form role="form">
            <div class="form-group">
                <label for="response-sheet">Upload your response sheet (HTML only)</label>
                <input class="form-control my-2" type="file" id="response-sheet" accept=".html">
            </div>
            <div class="form-group">
                <label for="answer-key">Upload the answer key (HTML only)</label>
                <input class="form-control my-2" type="file" id="answer-key" accept=".html">
            </div>
            <button type="button" class="btn btn-primary mb-4 mt-2" onclick="doTheMath()">Submit</button>
        </form>
        <div class="card mb-4">
            <h5 class="card-header d-flex flex-row"><span class="col-4">JEE Mains Score</span><span class="col-8" id="total-score">To be calculated</span></h5>
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex flex-row"><span class="col-4">Physics</span><span class="col-8" id="Physics">To be calculated</span></li>
                <li class="list-group-item d-flex flex-row"><span class="col-4">Chemistry</span><span class="col-8" id="Chemistry">To be calculated</span></li>
                <li class="list-group-item d-flex flex-row"><span class="col-4">Mathematics</span><span class="col-8" id="Mathematics">To be calculated</span></li>
            </ul>
        </div>
        <!--<div class="score mb-4">-->
        <!--Your aggregate score will show up here.-->
        <!--</div>-->
        <table id="responses" class="table table-responsive">
            <thead class="table-dark">
            <tr>
                <td>Question Number</td>
                <td>Attempt Status</td>
                <td>Correct Answer</td>
                <td>Marked Answer</td>
            </tr>
            </thead>
            <tbody id="responses-table-body"></tbody>
        </table>
    </main>
    <div class="col-12 col-md-1 col-xl-1"></div>
</div>
<script>
  const responseSheet = document.getElementById('response-sheet');
  const sheetDoc = document.implementation.createHTMLDocument("Response-Sheet").documentElement;
  responseSheet.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        var reader = new FileReader();
        reader.onload = (evt) => {
            var text = evt.target.result;
            sheetDoc.innerHTML = text;
        }
        reader.readAsText(file);
    } else {
        document.querySelector(".response-sheet-content").textContent = "Failed to load response-sheet";
    }
  });

  const answerKey = document.getElementById('answer-key');
  const keyDoc = document.implementation.createHTMLDocument("Answer-Key").documentElement;
  answerKey.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        var reader = new FileReader();
        reader.onload = (evt) => {
            var text = evt.target.result;
            keyDoc.innerHTML = text;
        }
        reader.readAsText(file);
    } else {
        document.querySelector(".answer-key-content").textContent = "Failed to load answer-key";
    }
  });

    const doTheMath = () => {

        var scores = new Map();
        ["Physics", "Chemistry", "Mathematics", "total-score"].forEach((subject) => { scores.set(subject, 0); } );

        var answerKeyRows = keyDoc.getRootNode().getElementById("ctl00_LoginContent_grAnswerKey").getElementsByTagName("tr")
        var i = 1;
        var count = 0;
        var answerMap = new Map();
        while (count < 90) {
            var answerDetails = answerKeyRows[i].getElementsByTagName("span");
            var quesType = answerDetails[0].textContent;
            var questionNo = answerDetails[1].textContent;
            var correctAnswer = answerDetails[2].textContent;
            answerMap.set(questionNo, { type : quesType, answer : correctAnswer });
            if(quesType === "Objective") i++;
            i++;
            count++;
        }

        var sections = sheetDoc.getElementsByClassName("section-cntnr");
        for(var i = 0 ; i < sections.length ; i++) {
            var section = sections[i];
            var sectionName = section.getElementsByClassName("section-lbl")[0].children[1].textContent;
            var subject = sectionName.split(" ")[0];
            var questions = section.getElementsByClassName("questionPnlTbl");
            for(var j = 0 ; j < questions.length ; j++) {
                var question = questions[j];
                var questionRowDetails = question.getElementsByClassName("questionRowTbl")[0].getElementsByTagName("tr")
                var questionLabel = questionRowDetails[1].children[0].textContent
                var questionDetails = question.getElementsByClassName("menu-tbl")[0].getElementsByTagName("tr")
                var questionType = questionDetails[0].children[1].textContent
                var questionId = questionDetails[1].children[1].textContent
                var status = questionType == "MCQ" ? questionDetails[6].children[1].textContent : questionDetails[2].children[1].textContent;
                var markedAnswer = questionType == "MCQ" ? questionDetails[7].children[1].textContent : questionRowDetails[4].children[1].textContent
                var correctAnswer = getCorrectAnswer(questionDetails, answerMap.get(questionId).answer);
                var scoreForThisQuestion = 0;
                if(correctAnswer === markedAnswer) scoreForThisQuestion = 4;
                else if(questionType === "MCQ" && !isNaN(markedAnswer) && !isNaN(correctAnswer)) scoreForThisQuestion--;
                scores.set("total-score", scores.get("total-score") + scoreForThisQuestion);
                scores.set(subject, scores.get(subject) + scoreForThisQuestion);
                appendToTable([sectionName + " " + questionLabel, status, correctAnswer, markedAnswer]);
            }
        }
        scores.forEach((value, key) => {
            document.querySelector("#" + key).textContent = value;
        });
    }

    const getCorrectAnswer = (questionDetails, answer) => {
        if(questionDetails[0].children[1].textContent == "SA") return answer;
        for(var i = 2 ; i < 6 ; i++) {
            if(answer === questionDetails[i].children[1].textContent) return (i - 1).toString();
        }
        return answer;
    }

    const appendToTable = (tableRowContents) => {
        var newRow = document.getElementById("responses-table-body").insertRow()
        for(var i = 0 ; i < 4 ; i++) {
            var newCell = newRow.insertCell();
            newCell.appendChild(document.createTextNode(tableRowContents[i]));
        }
        newRow.setAttribute('class', findCorrectness(tableRowContents.slice(1, 4)));
    }

    const findCorrectness = (answerDetails) => {
        if(answerDetails[0] === "Answered") {
            if(answerDetails[1] === answerDetails[2]) return "table-success";
            return "table-danger";
        }
        return "";
    }
</script>
<!-- Footer -->
<footer class="bg-dark text-center text-white">
    <!-- Grid container -->
    <div class="container p-4">
        <!-- Section: Social media -->
        <section class="mb-4">

            <!-- Linkedin -->
            <a class="btn btn-outline-light btn-floating m-1" href="https://www.linkedin.com/in/priyanshsaxena" role="button"><i class="fab fa-linkedin-in"></i></a>

            <!-- Github -->
            <a class="btn btn-outline-light btn-floating m-1" href="https://www.github.com/priyanshsaxena" role="button"><i class="fab fa-github"></i></a>
        </section>
        <!-- Section: Social media -->
    </div>
    <!-- Grid container -->

    <!-- Copyright -->
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
        Â© 2021 Copyright:
        <a class="text-white" href="https://priyanshsaxena.com/">priyanshsaxena.com</a>
    </div>
    <!-- Copyright -->
</footer>
<!-- Footer -->
</body>
</html>